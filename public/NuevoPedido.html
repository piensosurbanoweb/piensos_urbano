<div id="pestanaNuevoPedido" class="p-6">
    <h2 class="text-2xl font-bold text-gray-800 mb-6">Registrar Nuevo Pedido</h2>

    <form id="nuevoPedidoForm" class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="relative">
                <label class="block text-sm font-medium text-gray-700 mb-2">Apodo del Cliente</label>
                <input type="text" id="apodoAutoComplete" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg" placeholder="Escribe el apodo..." autocomplete="off">
                <div id="autocompleteSuggestions" class="autocomplete-suggestions hidden"></div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Nombre Completo</label>
                <input type="text" id="nombreCompleto" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 text-lg" readonly>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Zona de Reparto</label>
                <input type="text" id="zonaReparto" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 text-lg" readonly>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Localidad</label>
                <input type="text" id="localidad" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 text-lg" readonly>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Pedido *</label>
                <select id="tipoPedido" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg" required>
                    <option value="">Seleccionar tipo...</option>
                    <option value="diario">Diario</option>
                    <option value="semanal">Semanal</option>
                </select>
            </div>
            <div id="diasSemanaContainer" class="hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">D√≠a(s) de la semana</label>
                <select id="diaSemana" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg" required>
                    <option value="">Seleccionar d√≠a...</option>
                    <option value="lunes">Lunes</option>
                    <option value="martes">Martes</option>
                    <option value="miercoles">Mi√©rcoles</option>
                    <option value="jueves">Jueves</option>
                    <option value="viernes">Viernes</option>
                    <option value="sabado">S√°bado</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Cantidad *</label>
                <input type="number" id="cantidad" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg" required>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Producto *</label>
                <input type="text" id="producto" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg" required>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Fecha de Entrega</label>
                <input type="date" id="fechaEntregaNuevo" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg" required>
            </div>
        </div>

        <div class="mt-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Observaciones del Pedido</label>
            <textarea id="observacionesPedido" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg" placeholder="Notas adicionales para este pedido..."></textarea>
        </div>

        <div class="flex gap-4">
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-medium text-lg transition-colors duration-200">
                üíæ Registrar Pedido
            </button>
            <button type="button" onclick="limpiarFormularioPedido()" class="bg-gray-500 hover:bg-gray-600 text-white px-8 py-3 rounded-lg font-medium text-lg transition-colors duration-200">
                üóëÔ∏è Limpiar Formulario
            </button>
        </div>
    </form>
</div>

<script>
    let clienteSeleccionado = null;

    async function cargarClientesParaAutocomplete() {
        try {
            const res = await fetch('/clientes');
            const clientes = await res.json();
            const apodoInput = document.getElementById('apodoAutoComplete');
            const autocompleteSuggestions = document.getElementById('autocompleteSuggestions');
            
            apodoInput.addEventListener('input', () => {
                const query = apodoInput.value.toLowerCase();
                autocompleteSuggestions.innerHTML = '';
                if (query.length > 0) {
                    const matches = clientes.filter(c => c.apodo.toLowerCase().includes(query));
                    if (matches.length > 0) {
                        matches.forEach(cliente => {
                            const li = document.createElement('li');
                            li.textContent = cliente.apodo;
                            li.addEventListener('click', () => {
                                apodoInput.value = cliente.apodo;
                                clienteSeleccionado = cliente;
                                rellenarCamposCliente(cliente);
                                autocompleteSuggestions.classList.add('hidden');
                            });
                            autocompleteSuggestions.appendChild(li);
                        });
                        autocompleteSuggestions.classList.remove('hidden');
                    } else {
                        autocompleteSuggestions.classList.add('hidden');
                    }
                } else {
                    autocompleteSuggestions.classList.add('hidden');
                }
            });
        } catch (err) {
            console.error('Error al cargar clientes para autocompletado:', err);
        }
    }

    function rellenarCamposCliente(cliente) {
        document.getElementById('nombreCompleto').value = cliente.nombre_completo;
        document.getElementById('zonaReparto').value = cliente.zona_reparto;
        document.getElementById('localidad').value = cliente.localidad;
    }

    document.getElementById('nuevoPedidoForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!clienteSeleccionado) {
            alert('Por favor, selecciona un cliente v√°lido del autocompletado.');
            return;
        }

        const pedidoData = {
            cliente_id: clienteSeleccionado.id,
            apodo_cliente: clienteSeleccionado.apodo,
            tipo: document.getElementById('tipoPedido').value,
            dia_semana: document.getElementById('diaSemana').value,
            cantidad: document.getElementById('cantidad').value,
            producto: document.getElementById('producto').value,
            fecha_entrega: document.getElementById('fechaEntregaNuevo').value,
            observaciones: document.getElementById('observacionesPedido').value
        };

        try {
            const res = await fetch('/pedidos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(pedidoData)
            });
            if (res.ok) {
                alert('Pedido registrado con √©xito!');
                limpiarFormularioPedido();
                clienteSeleccionado = null;
            } else {
                console.error('Error al registrar pedido');
            }
        } catch (err) {
            console.error('Error de red:', err);
        }
    });

    function limpiarFormularioPedido() {
        document.getElementById('nuevoPedidoForm').reset();
        document.getElementById('apodoAutoComplete').value = '';
        document.getElementById('nombreCompleto').value = '';
        document.getElementById('zonaReparto').value = '';
        document.getElementById('localidad').value = '';
        document.getElementById('autocompleteSuggestions').classList.add('hidden');
        clienteSeleccionado = null;
    }

    document.addEventListener('DOMContentLoaded', () => {
        cargarClientesParaAutocomplete();
    });
</script>